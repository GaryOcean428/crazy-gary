{
  "$schema": "https://schema.railpack.com",
  "provider": "python",
  "metadata": {
    "name": "crazy-gary",
    "description": "Heavy-powered autonomous agentic AI system with Flask API and React frontend",
    "version": "1.0.0"
  },
  "buildAptPackages": [
    "git",
    "curl",
    "build-essential"
  ],
  "packages": {
    "python": "3.11",
    "node": "18"
  },
  "steps": {
    "install": {
      "commands": [
        {
          "cmd": "python -m pip install --upgrade pip || echo 'Warning: pip upgrade failed, continuing with existing version'",
          "customName": "Upgrade pip"
        },
        {
          "cmd": "cd apps/api && pip install --no-cache-dir -r requirements.txt",
          "customName": "Install Python dependencies"
        },
        {
          "cmd": "cd apps/web && (npm ci --legacy-peer-deps && echo 'Used npm ci for installation' || (npm install --legacy-peer-deps && echo 'Fallback: Used npm install'))",
          "customName": "Install Node.js dependencies"
        }
      ]
    },
    "build": {
      "inputs": [
        {
          "step": "install"
        }
      ],
      "commands": [
        {
          "cmd": "echo 'üé® Building React frontend...'",
          "customName": "Frontend build start"
        },
        {
          "cmd": "cd apps/web && NODE_ENV=production npm run build",
          "customName": "Build React application"
        },
        {
          "cmd": "echo 'üìÅ Preparing static directory...'",
          "customName": "Prepare static directory"
        },
        {
          "cmd": "mkdir -p apps/api/src/static",
          "customName": "Create static directory"
        },
        {
          "cmd": "rm -rf apps/api/src/static/* || true",
          "customName": "Clear existing static files"
        },
        {
          "cmd": "cp -r apps/web/dist/* apps/api/src/static/ && echo '‚úÖ Frontend built and integrated successfully'",
          "customName": "Copy built frontend to Flask static"
        }
      ],
      "deployOutputs": [
        {
          "name": "python_app",
          "files": [
            "apps/api",
            "apps/web/dist"
          ]
        }
      ]
    }
  },
  "deploy": {
    "startCommand": "cd apps/api && python -m gunicorn --worker-class gevent --workers 1 --bind 0.0.0.0:$PORT --timeout 120 --keep-alive 5 --max-requests 1000 --max-requests-jitter 50 --log-level info --access-logfile - --error-logfile - src.main:app",
    "healthCheckPath": "/api/health",
    "healthCheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3,
    "environmentVariables": {
      "PYTHONPATH": "/workspace/crazy-gary/apps/api",
      "FLASK_ENV": "production",
      "PYTHONUNBUFFERED": "1",
      "PORT": "${PORT}",
      "HOST": "0.0.0.0",
      "ENVIRONMENT": "production"
    }
  }
}
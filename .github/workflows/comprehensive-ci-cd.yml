name: Comprehensive CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  quality-gates:
    name: Quality Gates (Fast)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
          
      - name: TypeScript compilation
        run: |
          cd apps/web
          npm run type-check
          
      - name: ESLint
        run: |
          cd apps/web
          npm run lint
          
      - name: Prettier check
        run: |
          cd apps/web
          npm run format:check
          
      - name: Quick unit tests
        run: |
          cd apps/web
          npm run test -- --run --reporter=verbose
          
      - name: Quality Gate Evaluation
        run: |
          echo "âœ… Quality gates passed - proceeding to comprehensive testing"
          
  comprehensive-testing:
    name: Comprehensive Testing
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: quality-gates
    strategy:
      fail-fast: false
      matrix:
        node-version: [18, 20]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
          cd ../../apps/api
          pip install -r requirements.txt
          
      - name: Build application
        run: |
          cd apps/web
          npm run build
          
      - name: Run tests with coverage
        run: |
          cd apps/web
          npm run test:coverage
          
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./apps/web/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          
  security-scanning:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run security audit
        run: |
          cd apps/web
          npm audit --audit-level moderate
          
      - name: Semgrep SAST
        uses: semgrep/semgrep-action@v1
        with:
          config: auto
          
      - name: Secret scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    needs: [comprehensive-testing, security-scanning]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
          
      - name: Build for production
        run: |
          cd apps/web
          npm run build:production
          
      - name: Deploy to Railway
        run: |
          echo "ðŸš€ Deploying to Railway..."
          # Railway deployment would be configured here
          
      - name: Post-deployment verification
        run: |
          echo "âœ… Deployment completed successfully"
